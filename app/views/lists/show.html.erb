
<h1><%= @list.name %></h1>

<% if @items.any? %>
  <div class="sorting-options">
    <button id="ordenar-lista-button">Ordenar Lista</button>
    <div class="opcoes-tags" style="display:none;">
      <% if @available_tags.any? %>
        <% @available_tags.each do |tag| %>
          <%= link_to tag, list_path(@list, order: tag) %>
        <% end %>
      <% end %>

      <%= link_to "Agrupar", list_path(@list, order: 'agrupar') %>
      <%= link_to "Desagrupar", list_path(@list, order: 'desagrupar') %>
    </div>
  </div>

  <table class="table table-striped">
    <thead>
      <tr>
        <th>Item</th>
        <th>Pre√ßo Unit√°rio</th>
        <th>Quantidade</th>
        <th>Quantidade Comprada</th>
        <th>Falta Comprar</th>
        <th>Subtotal</th>
      </tr>
    </thead>
    <tbody>
      <% @items.each do |item| %>
        <tr id="item-<%= item.id %>">
          <td>
            <strong><%= item.name %></strong>
            <% if item.tag.present? %>
              <br><small class="text-muted">(<%= item.tag %>)</small>
            <% end %>
          </td>
          <td>
            <%= number_to_currency(item.preco, unit: "R$ ", separator: ",", delimiter: ".") %>
          </td>
          <td><%= item.quantity %></td> <!-- LINHA CORRIGIDA -->
          <td>
            <div class="quantity-control">
              <%= form_with(model: item, url: list_item_path(@list, item), method: :patch,
                  data: { remote: true }, class: "quantity-form") do |f| %>
                <%= f.number_field :quantidade_comprada, value: item.quantidade_comprada || 0,
                    min: 0, max: item.quantity, class: "form-control form-control-sm",
                    style: "width: 80px; display: inline;" %>
                <%= f.submit "‚úì", class: "btn btn-sm btn-success", title: "Atualizar" %>
              <% end %>
            </div>
          </td>
          <td>
            <% falta_comprar = item.quantity - (item.quantidade_comprada || 0) %> <!-- LINHA CORRIGIDA -->
            <span class="badge <%= falta_comprar > 0 ? 'bg-warning' : 'bg-success' %>">
              <%= falta_comprar %>
            </span>
          </td>
          <td>
            <%= number_to_currency(item.quantity * item.preco, unit: "R$ ", separator: ",", delimiter: ".") %> <!-- LINHA CORRIGIDA -->
          </td>
        </tr>
      <% end %>
    </tbody>
    <tfoot>
      <tr class="table-info">
        <td colspan="3" class="text-end"><strong>Totais:</strong></td>
        <td><strong><%= @items.sum(:quantidade_comprada) || 0 %></strong></td>
        <td><strong><%= @items.sum(:quantity) - (@items.sum(:quantidade_comprada) || 0) %></strong></td> <!-- LINHA CORRIGIDA -->
        <td><strong><%= number_to_currency(@total_estimado, unit: "R$ ", separator: ",", delimiter: ".") %></strong></td>
      </tr>
    </tfoot>
  </table>
<% else %>
  <div class="alert alert-info">
    Esta lista ainda n√£o tem itens.
  </div>
<% end %>

<% if @list.owner == current_user || @list.shared_users.include?(current_user) %>
  <div class="card mt-4">
    <div class="card-header">
      <h5 class="mb-0">Compartilhamento</h5>
    </div>
    <div class="card-body">
      <% if @list.owner == current_user %>
        <p class="card-text">
          <strong>Dono:</strong> Voc√™<br>
          <strong>Usu√°rios com acesso:</strong>
          <%= @list.shared_users.count + 1 %>
          (voc√™ + <%= @list.shared_users.count %> usu√°rio(s))
        </p>

        <ul class="list-unstyled mb-3">
          <li><strong>‚Ä¢ <%= current_user.email %></strong> (voc√™ - dono)</li>
          <% @list.shared_users.each do |user| %>
            <li>‚Ä¢ <%= user.email %></li>
          <% end %>
        </ul>

        <%= link_to "Gerenciar compartilhamento", edit_list_path(@list),
            class: "btn btn-outline-primary btn-sm" %>
      <% else %>
        <p class="card-text">
          <strong>Dono:</strong> <%= @list.owner.email %><br>
          <strong>Compartilhado com voc√™ por:</strong> <%= @list.owner.email %>
        </p>
        <p class="text-muted">
          <small>Voc√™ tem permiss√£o para editar quantidades nesta lista.</small>
        </p>
      <% end %>
    </div>
  </div>
<% end %>
<% if @list.owner == current_user %>
  <hr class="my-4 border-warning">

  <div class="card border-warning">
    <div class="card-header bg-warning text-dark">
      <h5 class="mb-0">üîÑ Reiniciar Lista</h5>
    </div>
    <div class="card-body">
      <p class="card-text">
        <strong>Esta a√ß√£o ir√°:</strong>
      </p>
      <ul>
        <li>Marcar todos os itens como <strong>n√£o comprados</strong></li>
        <li>Zerar a quantidade comprada de todos os itens</li>
        <li>Manter os itens na lista</li>
      </ul>
      <p class="text-muted">
        <small>Use esta a√ß√£o quando quiser come√ßar uma nova rodada de compras com os mesmos itens.</small>
      </p>

      <div class="d-grid gap-2 d-md-block">
        <%= button_to "üîÑ Reiniciar Lista Agora",
            reset_list_path(@list),
            method: :post,
            data: {
              confirm: "Tem certeza que deseja reiniciar a lista '#{@list.name}'?\n\nTodos os itens ser√£o marcados como n√£o comprados.",
              turbo_confirm: "Tem certeza que deseja reiniciar a lista '#{@list.name}'?\n\nTodos os itens ser√£o marcados como n√£o comprados.",
              disable_with: "Reiniciando..."
            },
            class: "btn btn-warning btn-lg",
            form_class: "d-inline" %>

        <%= link_to "‚úèÔ∏è Editar Lista", edit_list_path(@list), class: "btn btn-outline-primary" %>
      </div>
    </div>
  </div>
<% end %>
<div class="mt-4">
  <%= link_to "Adicionar Novo Item", new_list_item_path(@list), class: "btn btn-primary" %>
  <%= link_to "Voltar para Listas", lists_path, class: "btn btn-secondary" %>
</div>

<script>
  document.getElementById('ordenar-lista-button')?.addEventListener('click', function() {
    var opcoes = document.querySelector('.opcoes-tags');
    if (opcoes.style.display === 'none') {
      opcoes.style.display = 'block';
    } else {
      opcoes.style.display = 'none';
    }
  });
</script>